#!/bin/bash
WALLPAPER_DIR="$HOME/Desktop/dotfiles/deploy"
LOG_FILE="$HOME/.cache/wallpaper-debug.log"

[ "$DEBUG" != "1" ] && LOG_FILE="/dev/null"

# Quick environment check
if [ -z "$WAYLAND_DISPLAY" ]; then
    echo "$(date): No WAYLAND_DISPLAY available" >> "$LOG_FILE"
    exit 1
fi

# Get hour and determine wallpaper
CURRENT_HOUR=$(date +%-H)
case $CURRENT_HOUR in
    2|3|4|5)   WALLPAPER="$WALLPAPER_DIR/background-image.png"; PERIOD="dusk" ;;
    6|7|8|9)   WALLPAPER="$WALLPAPER_DIR/background-image.png"; PERIOD="morning" ;;
    10|11|12|13|14|15) WALLPAPER="$WALLPAPER_DIR/background-image.png"; PERIOD="afternoon" ;;
    16|17|18|19) WALLPAPER="$WALLPAPER_DIR/background-image.png"; PERIOD="evening" ;;
    *) WALLPAPER="$WALLPAPER_DIR/background-image.png"; PERIOD="night" ;;
esac

echo "$(date): Hour=$CURRENT_HOUR, Selected $PERIOD wallpaper" >> "$LOG_FILE"

# Check if wallpaper file exists
if [ ! -f "$WALLPAPER" ]; then
    echo "$(date): Error: Wallpaper file $WALLPAPER not found" >> "$LOG_FILE"
    exit 1
fi

if ! swww query &>/dev/null; then
    echo "$(date): Starting swww-daemon" >> "$LOG_FILE"
    swww-daemon --format xrgb &
    sleep 0.2  
fi


# Apply wallpaper
echo "$(date): Applying $WALLPAPER" >> "$LOG_FILE"
if swww img "$WALLPAPER" --transition-type none --transition-duration 0; then
    echo "$(date): Wallpaper applied successfully" >> "$LOG_FILE"
else
    echo "$(date): Failed to apply wallpaper" >> "$LOG_FILE"
    exit 1
fi

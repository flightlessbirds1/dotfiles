#!/usr/bin/env bash
# mpvpaper version of wallpaper switcher
WALLPAPER_DIR="$HOME/Desktop/dotfiles/deploy"
LOG_FILE="$HOME/.cache/wallpaper-mpv-debug.log"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

# Quick environment check
if [ -z "$WAYLAND_DISPLAY" ]; then
    echo "$(date): No WAYLAND_DISPLAY available" >> "$LOG_FILE"
    exit 1
fi

# Get hour and determine wallpaper
CURRENT_HOUR=$(date +%-H)
case $CURRENT_HOUR in
    2|3|4|5)   WALLPAPER="$WALLPAPER_DIR/dusk.gif"; PERIOD="dusk" ;;
    6|7|8|9)   WALLPAPER="$WALLPAPER_DIR/morning.gif"; PERIOD="morning" ;;
    10|11|12|13|14|15) WALLPAPER="$WALLPAPER_DIR/afternoon.gif"; PERIOD="afternoon" ;;
    16|17|18|19) WALLPAPER="$WALLPAPER_DIR/evening.gif"; PERIOD="evening" ;;
    *) WALLPAPER="$WALLPAPER_DIR/night.gif"; PERIOD="night" ;;
esac

echo "$(date): Hour=$CURRENT_HOUR, Selected $period wallpaper" >> "$LOG_FILE"

# Check if wallpaper file exists
if [ ! -f "$WALLPAPER" ]; then
    echo "$(date): Error: Wallpaper file $WALLPAPER not found" >> "$LOG_FILE"
    exit 1
fi

# Kill existing mpvpaper processes
pkill -f mpvpaper

# Start mpvpaper with memory-efficient options
echo "$(date): Starting mpvpaper with $WALLPAPER" >> "$LOG_FILE"
mpvpaper -o "no-audio --loop --hwdec=auto --vo=gpu --gpu-context=wayland" '*' "$WALLPAPER" &

echo "$(date): mpvpaper started successfully" >> "$LOG_FILE"
